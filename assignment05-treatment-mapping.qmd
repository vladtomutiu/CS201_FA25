---
title: "Assignment 5: Substance Abuse Treatment Mapping"
subtitle: "STUDENT NAME"
author: "Amber Camp"
date: "`r Sys.Date()`"
format: html
editor: visual
---

## Overview

Due: **Tuesday, 10/7 11:59pm**

In this assignment, you will apply analytic and mapping skills on the TEDS-D dataset from SAMHSA.

Refer to the following files for reference, though some of what is asked of you in this assignment will require logic beyond what was discussed here:

-   week06-treatment-mapping-part1.qmd

-   week06-treatment-mapping-part2.qmd

Total time estimate: Two hours

## Load Packages and Data

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
library(janitor) 
library(arrow) # lets us read/write parquet and feather files
library(sf) # "simple features" for spatial data
library(urbnmapr) # access to US state/country shapefiles for mapping
library(naniar) # tools for exploring and visualizing missing data
library(ggiraph) # makes ggplot charts interactive
options(scipen = 99) # turns off scientific notation

```

```{r}
teds_d <- read_parquet(here("data/teds_d_clean.parquet"))
```

## Question 1

Make an interactive map with `ggiraph` showing the percentage of completed treatments that end with no use at discharge. I am looking for a single interactive map as the final product.

Hint: Break this question down into bite-sized steps, like we did in Part 2. The `freq1_d` column contains information about use at discharge. Check your denominator carefully — should it be *all cases* or *completed cases*?

```{r}
class(teds_d$freq1_d)
summary(teds_d$freq1_d)

teds_d %>%
  tabyl(freq1_d)

percent_no_use_by_state <- teds_d %>%
  filter(reason == "Treatment completed") %>%
  group_by(stfips) %>%
  summarize(
  completed_cases = n(),
  no_use = sum(freq1_d == "no use", na.rm = TRUE),
  percent_no_use = 100 * (no_use / completed_cases)
  )

summary(percent_no_use_by_state)

percent_no_use_by_state <- percent_no_use_by_state %>%
  mutate(percentage_bin = cut(percent_no_use, 
                              breaks = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100),
                              labels = c("0–10%", "10–20%", "20–30%", "30–40%", "40–50%", "50–60%", "60–70%", "70–80%", "80–90%", "90–100%"),
                              include.lowest = TRUE))

assignment5Q1_data <- percent_completed_by_state_map %>%
  left_join(percent_no_use_by_state, by = "stfips")

question1map <- ggplot(assignment5Q1_data) +
  geom_sf_interactive(
    aes(geometry = geometry,
        fill = percentage_bin.y,
        tooltip = paste("State:", state_abbv,
                        "<br>FIPS:", stfips,
                        "<br>% No Use at Discharge:", sprintf("%.2f", percent_no_use), "%")),
    color = "#ffffff", size = 0.25) +
  labs(fill = "% No Use at Discharge",
       title = "No Use at Discharge Among Completed Treatment Episodes",
       subtitle = "TEDS-D Dataset (SAMHSA)") +
  scale_fill_viridis_d(option = "mako", direction = -1) +
  coord_sf(datum = NA) +
  theme_minimal() +
  theme(panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        legend.text = element_text(size = 4),
        legend.title = element_text(size = 5),
        strip.text = element_text(size = 4))

girafe(ggobj = question1map)
```

## Question 2

Treatment outcomes can vary depending on the type of service patients receive and the length of stay in treatment.

-   Investigate how the percentage of treatments completed and the percentage of treatments that end with no use at discharge differ when you look at service type and length of stay.

-   Create at least three different visualizations to help answer this question.

-   At least one visualization should focus on service type and at least one should focus on length of stay. A third visualization should compare the two.

-   After making your visualizations, write a short summary (3-ish sentences) that explains the main patterns you observe. Please use full, grammatical sentences.

    harder, 4 variables for new dataframe

-   percentage treatment completed

-   percentage treatments no use

-   service type

-    length of stay

```{r}
teds_d %>% 
  tabyl(services_d)

combined_df <- teds_d %>%
  left_join(assignment5Q1_data, by = "stfips")

service_type_completed <- combined_df %>%
  group_by(services_d) %>%
  summarise(
    avg_percentage_completed = mean(percentage_completed, na.rm = TRUE),
    count = n()
  )

service_type_no_use <- combined_df %>%
  group_by(services_d) %>%
  summarise(
    avg_percent_no_use = mean(percent_no_use, na.rm = TRUE),
    count = n()
  )

los_completed <- combined_df %>%
  group_by(los) %>%
  summarise(
    avg_percentage_completed = mean(percentage_completed, na.rm = TRUE),
    count = n()
  )

los_no_use <- combined_df %>%
  group_by(los) %>%
  summarise(
    avg_percent_no_use = mean(percent_no_use, na.rm = TRUE),
    count = n()
  )

summary(service_type_completed)
summary(service_type_no_use)
summary(los_completed)
summary(los_no_use)

service_type_combined <- service_type_completed %>%
  left_join(service_type_no_use, by = "services_d")

ggplot(data = service_type_combined, aes(x = services_d,
                                          y = avg_percentage_completed,
                                          fill = services_d)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  coord_flip() +
  theme(legend.position = "none") +
  labs(
    title = "% of Treatments Completed by Service Type",
    x = "Service Type",
    y = "Average % Completed"
  )

los_combined <- los_completed %>%
  left_join(los_no_use, by = "los")

ggplot(data = los_combined, aes(x = los,
                                y = avg_percent_no_use,
                                fill = los)) +
  geom_histogram(stat = "identity") +
  theme_bw() +
  coord_flip() +
  theme(legend.position = "none") +
  labs(
    title = "% frequency of No Use After Discharge by Length of Stay",
    x = "Length of Stay",
    y = "% of No Use After Discharge"
  )

ggplot(data = service_type_combined, aes(x = avg_percentage_completed,
                                y = avg_percent_no_use,
                                color = services_d)) +
  geom_point() +
  theme_bw() +
  facet_wrap(~ services_d) + 
  labs(
    title = "Treatment Outcomes by service type",
    subtitle = "Comparing % Completed Treatments % No Use at Discharge",
    x = "Average % Completed Treatment",
    y = "Average % No Use at Discharge"
  )
```

Summary: The first visualization shows that for the most part, detoxification helped increase the percentage of treatments completed. The second visualization showed a slight increase in percentage of no use of substance after discharge. However overall, with the combined graph there seems to not be a clear pattern in the data other then detox meaning a higher average % completed treatment.

Assignment is due Tuesday 10/7 at 11:59 pm.
